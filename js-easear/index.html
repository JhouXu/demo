<!DOCTYPE html>
<html lang="ch-ZN">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EaseAr</title>
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
      }

      body {
        position: relative;
        width: 100vw;
        height: 100vh;
      }

      video,
      canvas {
        position: absolute;
        width: inherit;
        height: inherit;
      }
    </style>
  </head>
  <body>
    <canvas id="canvas"></canvas>
    <video id="video"></video>
  </body>
  <script>
    const videoElement = document.querySelector("#video");
    const videoSetting = videoElement.getBoundingClientRect();
    const canvasElement = document.querySelector("#canvas");
    const canvasContext = canvasElement.getContext("2d");

    // 更多参数请查看 https://developer.mozilla.org/en-US/docs/Web/API/MediaStreamConstraints
    const constraints = {
      audio: false,
      video: { facingMode: { exact: "environment" } },
      //video: {facingMode: {exact: 'user'}}
      //video: true
    };

    navigator.mediaDevices
      .getUserMedia(constraints)
      .then((stream) => {
        // videoElement为video元素，将摄像头视频流绑定到video上实时预览
        videoElement.srcObject = stream;
        videoElement.style.display = "block";
        videoElement.play();
        resolve(true);
      })
      .catch((err) => {
        // reject(err);
      });

    // canvasElement为canvas元素
    // canvasContext为canvas的context 2d对象
    // videoSetting为video元素的宽、高
    canvasContext.drawImage(videoElement, 0, 0, videoSetting.width, videoSetting.height);
    const image = canvasElement.toDataURL("image/jpeg", 0.5).split("base64,")[1];

    // 云图库的Client-end URL
    const clientendUrl = "https://396191d0bc46776a332f68a7c10d913d.cn1.crs.easyar.com:8443";
    // 云图库的Cloud Token
    const token =
      "BmNnPrQ6n8AAhf4lojbn5IHdruKqAJ9UnJaOlP235RXlDj0QyfWfHBa3ln82mC+k1siQKM7VkgZp1VP09Y9kUfqtNlx2BFYoYVT5n/jvogTOj5eo7Nnn5Yvv2d7obwA2AGOlO4X7ckepl5uQ/53cAnc04hNgwIQaPyFjaqNqiDL6dOlGmn71U6tw6FpGEq46NBawKlSLdkOEaUBqzttihWMkxtMSnEd+WpBL9THDqHAqoXzNH6ZJidWjW2S2BD5Gho5+p30l1/m5l9zhqS3Va0KXbiLWT7tQ/7crBm3/I2TWbWheMw9tqWNFS3JbQK8XEjlR0PeepvWkRYxVC8TMryPsx/g5amoVKF3SgKqX1MHEkRLSQlzNAqLdm44twgGsGszhLrwXBXddrJgUutNu+14DaYZkKTxWsG2hoEcA/oDGuRsfxs1s0U+gj6z51suSddTjrMAMFMSRg/WC5PjqNELApMlKi/iI2GA8t1g5V8U=";
    // 云图库的CRS AppId
    const appId = "b22a733c9d0916019976d9cbaa80a069";

    // 可以使用 jQuery 或 axios 等发送网络请求
    const http = new XMLHttpRequest();
    http.onload = () => {
      try {
        const msg = JSON.parse(http.responseText);
        if (http.status === 200) {
          if (msg.statusCode === 0) {
            resolve(msg.result);
          } else {
            reject(msg);
          }
        } else {
          reject(msg);
        }
      } catch (err) {
        reject(err);
      }
    };
    http.onerror = (err) => {
      reject(err);
    };

    // 发送到云图库服务器
    http.open("POST", clientendUrl);
    http.setRequestHeader("Content-Type", "application/json;Charset=UTF-8");

    // 将Cloud Token写在请求头中
    http.setRequestHeader("Authorization", token);

    // image为截取的摄像头图片数据，如：{image: '/9j/4AAQSkZJRgA...', appId: appId}
    http.send(JSON.stringify(image));
  </script>

  <script src="https://cdn.bootcdn.net/ajax/libs/vConsole/3.15.0/vconsole.min.js"></script>
  <script>
    new VConsole();
  </script>
</html>
